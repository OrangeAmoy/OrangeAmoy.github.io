<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="1. 技术简介&amp;emsp;&amp;emsp;DeepStream是NVIDIA推出的一个针对智能视频分析应用和多传感器处理的工具包，其主要特性为能够利用硬件加速技术将深度神经网络与其他的复杂处理任务带入流处理管道，让用户更专注于构建神经网络任务，而不是从头开始搭建端到端的解决方案。在以前，开发一个智能视频分析应用，用户除了需要构建神经网络，还需要考虑前端视频数据的获取、视频编解码、视频渲染等问题。然而这">
<meta property="og:type" content="article">
<meta property="og:title" content="NVIDIA DeepStream 简介">
<meta property="og:url" content="http://orangeamoy.com/2019/04/12/DeepStream/index.html">
<meta property="og:site_name" content="橙色空间">
<meta property="og:description" content="1. 技术简介&amp;emsp;&amp;emsp;DeepStream是NVIDIA推出的一个针对智能视频分析应用和多传感器处理的工具包，其主要特性为能够利用硬件加速技术将深度神经网络与其他的复杂处理任务带入流处理管道，让用户更专注于构建神经网络任务，而不是从头开始搭建端到端的解决方案。在以前，开发一个智能视频分析应用，用户除了需要构建神经网络，还需要考虑前端视频数据的获取、视频编解码、视频渲染等问题。然而这">
<meta property="og:locale">
<meta property="article:published_time" content="2019-04-12T10:00:00.000Z">
<meta property="article:modified_time" content="2021-09-05T11:19:00.983Z">
<meta property="article:author" content="Orange">
<meta property="article:tag" content="人工智能、计算机视觉、程序员">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://orangeamoy.com/2019/04/12/DeepStream/"/>





  <title>NVIDIA DeepStream 简介 | 橙色空间</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bcd436e3a081d5895b3cf9ec2dd0003e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">橙色空间</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">橙子的个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://orangeamoy.com/2019/04/12/DeepStream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="橙色空间">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">NVIDIA DeepStream 简介</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-12T18:00:00+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/" itemprop="url" rel="index">
                    <span itemprop="name">技术文档</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/%E8%A7%86%E9%A2%91%E5%BA%94%E7%94%A8/" itemprop="url" rel="index">
                    <span itemprop="name">视频应用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/04/12/DeepStream/" class="leancloud_visitors" data-flag-title="NVIDIA DeepStream 简介">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-技术简介"><a href="#1-技术简介" class="headerlink" title="1. 技术简介"></a>1. 技术简介</h1><p>&emsp;&emsp;DeepStream是NVIDIA推出的一个针对智能视频分析应用和多传感器处理的工具包，其主要特性为能够利用硬件加速技术将深度神经网络与其他的复杂处理任务带入流处理管道，让用户更专注于构建神经网络任务，而不是从头开始搭建端到端的解决方案。在以前，开发一个智能视频分析应用，用户除了需要构建神经网络，还需要考虑前端视频数据的获取、视频编解码、视频渲染等问题。然而这些问题的解决可能需要同时引入多个不同的开发工具包，诸如OpenCV，FFmpeg等。现在，通过DeepStream SDK便可以解决这些问题。<br>&emsp;&emsp;DeepStream的典型应用架构如图所示：  </p>
<div align=center>
<img src=https://s2.ax1x.com/2019/04/12/AbLT1O.png />
</div>  

<span id="more"></span>
<p>&emsp;&emsp;从本质上来说DeepStream是NVIDIA基于<a target="_blank" rel="noopener" href="https://gstreamer.freedesktop.org/">GStreamer</a>的插件系统开发的，自然也继承了GStreamer的特性。NVIDIA将自家的技术，如：TensorRT, cuDNN，CUDA, Video SDK等以插件的形式集成进GStreamer当中，以管线的形式进行智能视频分析应用的开发，将各个功能封装成组件，通过将对应功能的组件插入管线中，启动管线使数据按照要求在管线内流动，数据经过解析、编解码、预处理、算法处理后进行图像渲染或者发送到云端。下面对上述架构中的模块进行简要说明：  </p>
<ul>
<li>Video Decode: 视频解码模块。支持摄像头输入，RTSP格式输入，视频文件输入。  </li>
<li>Stream Mux: 数据聚合模块。能够将多路视频数据图像进行聚合，以批量的形式提供给下游推理引擎进行算法推理。  </li>
<li>Primary Detector: 一级检测。基于TensorRT的神经网络推理引擎，主要实现对图像中的目标进行检测。  </li>
<li>Object Tracker: 目标跟踪。对检测的目标进行跟踪，基于OpenCV实现。  </li>
<li>Secondary Classifiers: 二级分类。基于TensorRT的神经网络推理引擎，在一级检测的基础上对目标进行分类，或者结构化信息提取。  </li>
<li>Tiler: 视频阵列。将多个视频以阵列的形式进行组合，形成照片墙。  </li>
<li>OnScrenn Display: 视频结构化信息叠加。能够将结构化信息叠加在视频上，例如画矩形框，叠加文字信息等。  </li>
<li>Renderer: 视频渲染。对接受到的视频帧进行渲染并显示。  </li>
<li>Message Converter: 消息转换。将视频结构化信息转换成对应的消息格式，如JSON。  </li>
<li>Message Broker: 消息发送。将视频结构化信息等发送到云端。  </li>
</ul>
<p>&emsp;&emsp;参考资料：<br>&emsp;&emsp;<a target="_blank" rel="noopener" href="https://developer.nvidia.com/deepstream-sdk#github">DeepStream 3.0</a>  </p>
<h1 id="2-安装教程"><a href="#2-安装教程" class="headerlink" title="2. 安装教程"></a>2. 安装教程</h1><h2 id="2-1-依赖环境"><a href="#2-1-依赖环境" class="headerlink" title="2.1 依赖环境"></a>2.1 依赖环境</h2><ul>
<li>Ubuntu 16.04  </li>
<li>Gstreamer 1.8.3  </li>
<li>NVIDIA driver 410+  </li>
<li>CUDA 10  </li>
<li>cuDNN 7.3  </li>
<li>TensorRT 5.0  </li>
</ul>
<h2 id="2-2-移除旧版本DeepStream-可选"><a href="#2-2-移除旧版本DeepStream-可选" class="headerlink" title="2.2 移除旧版本DeepStream(可选)"></a>2.2 移除旧版本DeepStream(可选)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm -rf /usr/<span class="built_in">local</span>/deepstream \</span><br><span class="line">    /usr/lib/x86_64-linux-gnu/gstreamer-1.0/libgstnv* \</span><br><span class="line">    /usr/bin/deepstream-* \</span><br><span class="line">    /usr/lib/x86_64-linux-gnu/gstreamer-1.0/libnvdsgst*</span><br></pre></td></tr></table></figure>
<h2 id="2-3-安装步骤"><a href="#2-3-安装步骤" class="headerlink" title="2.3 安装步骤"></a>2.3 安装步骤</h2><p>1.安装必要的第三方开发包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install \</span><br><span class="line">    libssl1.0.0 \</span><br><span class="line">    libgstreamer1.0-0 \</span><br><span class="line">    gstreamer1.0-tools \</span><br><span class="line">    gstreamer1.0-plugins-good \</span><br><span class="line">    gstreamer1.0-plugins-bad \</span><br><span class="line">    gstreamer1.0-plugins-ugly \</span><br><span class="line">    gstreamer1.0-libav \</span><br><span class="line">    libgstrtspserver-1.0-0 \</span><br><span class="line">    libjansson4</span><br></pre></td></tr></table></figure></p>
<p>2.下载并安装CUDA 10，cuDNN 7.3，TensorRT 5.0<br>&emsp;&emsp;关于CUDA 10，cuDNN 7.3，TensorRT 5.0等安装教程本文暂不讨论，请另行参考对应教程。  </p>
<p>3.建立 libnvcuvid.so 软链接<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ln -s /usr/lib/nvidia-&lt;driver-version&gt;/libnvcuvid.so \</span><br><span class="line">                /usr/lib/x86_64-linux-gnu/libnvcuvid.so</span><br></pre></td></tr></table></figure><br>实际在/usr/lib/x86_64-linux-gnu/中已经有libnvcuvid.so文件，故暂未理解此操作意图。  </p>
<p>4.安装 librdkafka<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 从GitHub下载源码</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/edenhill/librdkafka.git</span><br><span class="line"><span class="comment"># 2. 配置与编译</span></span><br><span class="line">$ <span class="built_in">cd</span> librdkafka</span><br><span class="line">$ git reset --hard 7101c2310341ab3f4675fc565f64f0967e135a6a</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"><span class="comment"># 3. 拷贝生成的库文件至deepstream安装目录</span></span><br><span class="line">$ sudo mkdir -p /usr/<span class="built_in">local</span>/deepstream</span><br><span class="line">$ sudo cp /usr/<span class="built_in">local</span>/lib/librdkafka* /usr/<span class="built_in">local</span>/deepstream</span><br></pre></td></tr></table></figure></p>
<p>5.安装deepstream<br>&emsp;&emsp;从官网下载<a target="_blank" rel="noopener" href="https://developer.nvidia.com/compute/machine-learning/deepstream-downloads">DeepStream SDK</a>，并解压，进入文件根目录运行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tar -xvpf binaries.tbz2 -C /</span><br></pre></td></tr></table></figure></p>
<h2 id="2-4-验证安装"><a href="#2-4-验证安装" class="headerlink" title="2.4 验证安装"></a>2.4 验证安装</h2><p>&emsp;&emsp;命令行输入：deepstream-app -c &lt; path to config.txt &gt;，参考例子：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ deepstream-app -c samples/configs/deepstream-app/source30_720p_dec_infer-resnet_tiled_display_int8.txt</span><br></pre></td></tr></table></figure><br>如运行成功则有对应的日志及视频输出。  </p>
<h1 id="3-参考例子"><a href="#3-参考例子" class="headerlink" title="3. 参考例子"></a>3. 参考例子</h1><p>&emsp;&emsp;关于DeepStream使用的例子可自行参考DeepStream中对应的源码，本文不做重点描述。<br>&emsp;&emsp;本文着重描述如何利用插件进行自定义功能的开发。DeepStream插件参考源码见SDK目录下sources/gst-plugins/gst-dsexample文件夹。由于DeepStream是基于GStreamer开发的，因此DeepStream插件的开发也必然遵循GStreamer插件开发的约束。不过，一些简单的插件，特别是大部分神经网络推理类别的插件，即那种没有对原始视频或者图像进行操作，只是在其基础上使用算法进行特定功能分析的情况，可直接参考gst-dsexample，并进行简单的修改。如果需要对原始视频或者图像进行操作，则需要进一步深入研究GStreamer的原理与插件开发规则等。接下来主要从三个方面论述如何利用gst-dsexample进行插件开发。  </p>
<h2 id="3-1-关于gst-dsexample"><a href="#3-1-关于gst-dsexample" class="headerlink" title="3.1 关于gst-dsexample"></a>3.1 关于gst-dsexample</h2><h3 id="3-1-1-gst-dsexample简介"><a href="#3-1-1-gst-dsexample简介" class="headerlink" title="3.1.1 gst-dsexample简介"></a>3.1.1 gst-dsexample简介</h3><p>&emsp;&emsp;gst-dsexample基于GStreamer开发，继承至<a target="_blank" rel="noopener" href="https://gstreamer.freedesktop.org/data/doc/gstreamer/head/gstreamer-libs/html/GstBaseTransform.html">GstBaseTransform</a>类。gst-dsexample中共包含四个文件：gstdsexample.h，gstdsexample.cpp，dsexample_lib.h，dsexample_lib.c。gstdsexample主要实现插件的初始化，插件的注册等功能。dsexample_lib主要负责插件具体功能的实现，如目标检测与目标分类。每个插件均可单独配置不同的参数，用于对插件功能进行设置，如配置处理图像的宽和高、使用GPU的ID等。插件按数据流处理方式可分为直通式与非直通式。直通模式下，数据流直接通过插件，插件仅对流过的数据进行处理，并将处理后的结果附加在数据上传递给下游插件。如获取图像数据并通过算法进行目标检测，将目标检测结果附加在数据中，传递给下游组件，便于后续的分析。gst-dsexample就是直通式插件，获取图像数据并经过算法分析后，将分析结果附加在gst-buffer里，传递给下游组件。非直通模式下，数据流被插件截取并处理后再传递给下游插件，传递给下游的数据流可能由本插件生成，而不再是原始数据。例如图像缩放插件，当图像被放大时，图像数据空间已经改变，必须由缩放插件自行开辟数据空间，并将放大后的图像数据传递给下游。直通与非直通的区别，核心就在于数据流管理方式的不同。下面将对gst-dsexample的插件源码进行解析，关于GStreamer插件相关知识参考GStreamer官方介绍或者后续技术总结，本文会忽略相关知识。  </p>
<h3 id="3-1-2-gst-dsexample源码解析"><a href="#3-1-2-gst-dsexample源码解析" class="headerlink" title="3.1.2 gst-dsexample源码解析"></a>3.1.2 gst-dsexample源码解析</h3><p>gstdsexample.h<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __GST_DSEXAMPLE_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __GST_DSEXAMPLE_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gst/base/gstbasetransform.h&gt;</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;dsexample_lib/dsexample_lib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 插件描述信息，其中PACKAGE字段指定了插件的名称，通过该名称实现插件的调用。 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKAGE <span class="meta-string">&quot;dsexample&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VERSION <span class="meta-string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LICENSE <span class="meta-string">&quot;Proprietary&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DESCRIPTION <span class="meta-string">&quot;NVIDIA example plugin for integration with DeepStream on DGPU&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINARY_PACKAGE <span class="meta-string">&quot;NVIDIA DeepStream 3rdparty IP integration example plugin&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> URL <span class="meta-string">&quot;http://nvidia.com/&quot;</span></span></span><br><span class="line"></span><br><span class="line">G_BEGIN_DECLS</span><br><span class="line"><span class="comment">/* 固定结构，声明插件实例与插件类 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">GstDsExample</span> <span class="title">GstDsExample</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">GstDsExampleClass</span> <span class="title">GstDsExampleClass</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 固定结构 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_TYPE_DSEXAMPLE (gst_dsexample_get_type())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_DSEXAMPLE(obj) (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_DSEXAMPLE,GstDsExample))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_DSEXAMPLE_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_DSEXAMPLE,GstDsExampleClass))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_DSEXAMPLE_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS((obj), GST_TYPE_DSEXAMPLE, GstDsExampleClass))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_IS_DSEXAMPLE(obj) (G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_DSEXAMPLE))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_IS_DSEXAMPLE_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_DSEXAMPLE))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_DSEXAMPLE_CAST(obj)  ((GstDsExample *)(obj))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">GstDsExample</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    GstBaseTransform base_trans;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义算法实现</span></span><br><span class="line">    DsExampleCtx *dsexamplelib_ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义变量</span></span><br><span class="line">    guint unique_id;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">GstDsExampleClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    GstBaseTransformClass parent_class;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">GType <span class="title">gst_dsexample_get_type</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">G_END_DECLS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __GST_DSEXAMPLE_H__ */</span></span></span><br></pre></td></tr></table></figure><br>_GstDsExample为类的实例对象，里面可以存放运行时所需的变量。_GstDsExampleClass则为类，主要定义成员函数。可以看出GstBaseTransform继承至GstBaseTransform。程序所需的自定义函数或者变量可直接在_GstDsExample中添加，其余参数可视为固定模板，可不做修改。  </p>
<p>gstdsexample.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;gstdsexample.h&quot;</span></span></span><br><span class="line"><span class="built_in">GST_DEBUG_CATEGORY_STATIC</span> (gst_dsexample_debug);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_CAT_DEFAULT gst_dsexample_debug</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> GQuark _dsmeta_quark = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 插件属性的枚举变量 */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PROP_0,</span><br><span class="line">    PROP_UNIQUE_ID</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 插件属性默认值 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_UNIQUE_ID 15</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RGB_BYTES_PER_PIXEL 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设置插件sink和src端的连接方式与属性，这里设置数据存放于GPU中，所以内存指定为memory:NVMM */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GST_CAPS_FEATURE_MEMORY_NVMM <span class="meta-string">&quot;memory:NVMM&quot;</span></span></span><br><span class="line"><span class="keyword">static</span> GstStaticPadTemplate gst_dsexample_sink_template =</span><br><span class="line"><span class="built_in">GST_STATIC_PAD_TEMPLATE</span> (<span class="string">&quot;sink&quot;</span>,</span><br><span class="line">    GST_PAD_SINK,</span><br><span class="line">    GST_PAD_ALWAYS,</span><br><span class="line">    <span class="built_in">GST_STATIC_CAPS</span> (<span class="built_in">GST_VIDEO_CAPS_MAKE_WITH_FEATURES</span></span><br><span class="line">        (GST_CAPS_FEATURE_MEMORY_NVMM,</span><br><span class="line">            <span class="string">&quot;&#123; NV12, RGBA &#125;&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> GstStaticPadTemplate gst_dsexample_src_template =</span><br><span class="line"><span class="built_in">GST_STATIC_PAD_TEMPLATE</span> (<span class="string">&quot;src&quot;</span>,</span><br><span class="line">    GST_PAD_SRC,</span><br><span class="line">    GST_PAD_ALWAYS,</span><br><span class="line">    <span class="built_in">GST_STATIC_CAPS</span> (<span class="built_in">GST_VIDEO_CAPS_MAKE_WITH_FEATURES</span></span><br><span class="line">        (GST_CAPS_FEATURE_MEMORY_NVMM,</span><br><span class="line">            <span class="string">&quot;&#123; NV12, RGBA &#125;&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Define our element type. Standard GObject/GStreamer boilerplate stuff */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> gst_dsexample_parent_class parent_class</span></span><br><span class="line"><span class="built_in">G_DEFINE_TYPE</span> (GstDsExample, gst_dsexample, GST_TYPE_BASE_TRANSFORM);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* 插件的配置函数，配置子类的实现、插件属性、插件描述信息等。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_class_init</span> <span class="params">(GstDsExampleClass * klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GObjectClass *gobject_class;</span><br><span class="line">    GstElementClass *gstelement_class;</span><br><span class="line">    GstBaseTransformClass *gstbasetransform_class;</span><br><span class="line"></span><br><span class="line">    gobject_class = (GObjectClass *) klass;</span><br><span class="line">    gstelement_class = (GstElementClass *) klass;</span><br><span class="line">    gstbasetransform_class = (GstBaseTransformClass *) klass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 重构类的实现函数 */</span></span><br><span class="line">    gobject_class-&gt;set_property = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_dsexample_set_property);</span><br><span class="line">    gobject_class-&gt;get_property = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_dsexample_get_property);</span><br><span class="line"></span><br><span class="line">    gstbasetransform_class-&gt;set_caps = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_dsexample_set_caps);</span><br><span class="line">    gstbasetransform_class-&gt;start = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_dsexample_start);</span><br><span class="line">    gstbasetransform_class-&gt;stop = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_dsexample_stop);</span><br><span class="line">    <span class="comment">// 默认是直通模式下，所以子类重构的是transform_ip函数。</span></span><br><span class="line">    gstbasetransform_class-&gt;transform_ip =</span><br><span class="line">        <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_dsexample_transform_ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册插件属性 */</span></span><br><span class="line">    <span class="built_in">g_object_class_install_property</span> (gobject_class, PROP_UNIQUE_ID,</span><br><span class="line">        <span class="built_in">g_param_spec_uint</span> (<span class="string">&quot;unique-id&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Unique ID&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Unique ID for the element. Can be used to identify output of the&quot;</span></span><br><span class="line">            <span class="string">&quot; element&quot;</span>, <span class="number">0</span>, G_MAXUINT, DEFAULT_UNIQUE_ID, (GParamFlags)</span><br><span class="line">            (G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置sink和src的pad capabilities属性 */</span></span><br><span class="line">    <span class="built_in">gst_element_class_add_pad_template</span> (gstelement_class,</span><br><span class="line">        <span class="built_in">gst_static_pad_template_get</span> (&amp;gst_dsexample_src_template));</span><br><span class="line">    <span class="built_in">gst_element_class_add_pad_template</span> (gstelement_class,</span><br><span class="line">        <span class="built_in">gst_static_pad_template_get</span> (&amp;gst_dsexample_sink_template));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置插件描述信息 */</span></span><br><span class="line">    <span class="built_in">gst_element_class_set_details_simple</span> (gstelement_class,</span><br><span class="line">        <span class="string">&quot;DsExample plugin&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DsExample Plugin&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Process a 3rdparty example algorithm on objects / full frame&quot;</span>,</span><br><span class="line">        <span class="string">&quot;NVIDIA Corporation. Post on Deepstream for Tesla forum for any queries &quot;</span></span><br><span class="line">        <span class="string">&quot;@ https://devtalk.nvidia.com/default/board/209/&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_init</span> <span class="params">(GstDsExample * dsexample)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstBaseTransform *btrans = <span class="built_in">GST_BASE_TRANSFORM</span> (dsexample);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置是否基于同一内存空间处理buffer，在直通模式下，inbuf和outbuf是同一内存空间的。 */</span></span><br><span class="line">    <span class="built_in">gst_base_transform_set_in_place</span> (<span class="built_in">GST_BASE_TRANSFORM</span> (btrans), TRUE);</span><br><span class="line">    <span class="comment">/* 设置是否是直通模式，直通模式下调用的是transform_ip函数，非直通模式下调用transform */</span></span><br><span class="line">    <span class="built_in">gst_base_transform_set_passthrough</span> (<span class="built_in">GST_BASE_TRANSFORM</span> (btrans), TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置插件属性默认值 */</span></span><br><span class="line">    dsexample-&gt;unique_id = DEFAULT_UNIQUE_ID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This quark is required to identify NvDsMeta when iterating through</span></span><br><span class="line"><span class="comment">    * the buffer metadatas */</span></span><br><span class="line">    <span class="keyword">if</span> (!_dsmeta_quark)</span><br><span class="line">        _dsmeta_quark = <span class="built_in">g_quark_from_static_string</span> (NVDS_META_STRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* 设置插件属性信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_set_property</span> <span class="params">(GObject * object, guint prop_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> GValue * value, GParamSpec * pspec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstDsExample *dsexample = <span class="built_in">GST_DSEXAMPLE</span> (object);</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (prop_id) &#123;</span><br><span class="line">        <span class="keyword">case</span> PROP_UNIQUE_ID:</span><br><span class="line">            dsexample-&gt;unique_id = <span class="built_in">g_value_get_uint</span> (value);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">G_OBJECT_WARN_INVALID_PROPERTY_ID</span> (object, prop_id, pspec);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* 获取插件属性信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_get_property</span> <span class="params">(GObject * object, guint prop_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    GValue * value, GParamSpec * pspec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstDsExample *dsexample = <span class="built_in">GST_DSEXAMPLE</span> (object);</span><br><span class="line"></span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (prop_id) &#123;</span><br><span class="line">        <span class="keyword">case</span> PROP_UNIQUE_ID:</span><br><span class="line">        <span class="built_in">g_value_set_uint</span> (value, dsexample-&gt;unique_id);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">G_OBJECT_WARN_INVALID_PROPERTY_ID</span> (object, prop_id, pspec);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 初始化资源，如算法初始化。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> gboolean</span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_start</span> <span class="params">(GstBaseTransform * btrans)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstDsExample *dsexample = <span class="built_in">GST_DSEXAMPLE</span> (btrans);</span><br><span class="line">    DsExampleInitParams init_params =</span><br><span class="line">        &#123; dsexample-&gt;processing_width, dsexample-&gt;processing_height,</span><br><span class="line">        dsexample-&gt;process_full_frame</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Algorithm specific initializations and resource allocation. */</span></span><br><span class="line">    dsexample-&gt;dsexamplelib_ctx = <span class="built_in">DsExampleCtxInit</span> (&amp;init_params);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GST_DEBUG_OBJECT</span> (dsexample, <span class="string">&quot;ctx lib %p \n&quot;</span>, dsexample-&gt;dsexamplelib_ctx);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">    error:</span><br><span class="line">    <span class="keyword">if</span> (dsexample-&gt;dsexamplelib_ctx)</span><br><span class="line">        <span class="built_in">DsExampleCtxDeinit</span> (dsexample-&gt;dsexamplelib_ctx);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> gboolean</span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_stop</span> <span class="params">(GstBaseTransform * btrans)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstDsExample *dsexample = <span class="built_in">GST_DSEXAMPLE</span> (btrans);</span><br><span class="line">    <span class="comment">// 释放算法内存空间</span></span><br><span class="line">    <span class="built_in">DsExampleCtxDeinit</span> (dsexample-&gt;dsexamplelib_ctx);</span><br><span class="line">    dsexample-&gt;dsexamplelib_ctx = <span class="literal">NULL</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取协商好的caps参数，并进行相应的处理。如获取输入图像的宽高等信息。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> gboolean</span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_set_caps</span> <span class="params">(GstBaseTransform * btrans, GstCaps * incaps,</span></span></span><br><span class="line"><span class="params"><span class="function">    GstCaps * outcaps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstDsExample *dsexample = <span class="built_in">GST_DSEXAMPLE</span> (btrans);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">    error:</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 直通模式下，获取上游数据并进行算法处理后，将检测后的结果叠加在GstBuffer里面传递给下游。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> GstFlowReturn</span></span><br><span class="line"><span class="function"><span class="title">gst_dsexample_transform_ip</span> <span class="params">(GstBaseTransform * btrans, GstBuffer * inbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstDsExample *dsexample = <span class="built_in">GST_DSEXAMPLE</span> (btrans);</span><br><span class="line">    GstMapInfo in_map_info;</span><br><span class="line">    GstFlowReturn flow_ret = GST_FLOW_ERROR;</span><br><span class="line">    gdouble scale_ratio;</span><br><span class="line">    DsExampleOutput *output;</span><br><span class="line"></span><br><span class="line">    NvBufSurface *surface = <span class="literal">NULL</span>;</span><br><span class="line">    GstNvStreamMeta *streamMeta = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span> (&amp;in_map_info, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span> (in_map_info));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">gst_buffer_map</span> (inbuf, &amp;in_map_info, GST_MAP_READ)) &#123;</span><br><span class="line">        <span class="built_in">g_print</span> (<span class="string">&quot;Error: Failed to map gst buffer\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    surface = (NvBufSurface *) in_map_info.data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 从inbuf里面获取nvidia的streamMeta数据结构 */</span></span><br><span class="line">    streamMeta = <span class="built_in">gst_buffer_get_nvstream_meta</span> (inbuf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 对一级检测来说，处理的是整张图片，对二级分类来说，处理的是目标小图 */</span></span><br><span class="line">    <span class="keyword">if</span> (dsexample-&gt;process_full_frame) &#123;</span><br><span class="line">        <span class="keyword">for</span> (guint i = <span class="number">0</span>; i &lt; batch_size; i++) &#123;</span><br><span class="line">            NvOSD_RectParams rect_params;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义缩放图像的大小</span></span><br><span class="line">            rect_params.left = <span class="number">0</span>;</span><br><span class="line">            rect_params.top = <span class="number">0</span>;</span><br><span class="line">            rect_params.width = dsexample-&gt;video_info.width;</span><br><span class="line">            rect_params.height = dsexample-&gt;video_info.height;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对图像数据进行尺度缩放与空间转换等预处理操作</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">get_converted_mat_dgpu</span> (dsexample, surface-&gt;buf_data[i], &amp;rect_params,</span><br><span class="line">                    scale_ratio, dsexample-&gt;video_info.width,</span><br><span class="line">                    dsexample-&gt;video_info.height) != GST_FLOW_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> error;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 运行检测算法，获取检测结果。</span></span><br><span class="line">            output =</span><br><span class="line">                <span class="built_in">DsExampleProcess</span> (dsexample-&gt;dsexamplelib_ctx,</span><br><span class="line">                dsexample-&gt;cvmat-&gt;data);</span><br><span class="line">            <span class="comment">// 将检测结果叠加在inbuf里面传递给下游组件。</span></span><br><span class="line">            <span class="built_in">attach_metadata_full_frame</span> (dsexample, inbuf, scale_ratio, output, i);</span><br><span class="line">            <span class="built_in">free</span> (output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 针对二级分类进行处理 */</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    flow_ret = GST_FLOW_OK;</span><br><span class="line">    error:</span><br><span class="line">    <span class="built_in">gst_buffer_unmap</span> (inbuf, &amp;in_map_info);</span><br><span class="line">    <span class="keyword">return</span> flow_ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 释放申请的内存空间。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">free_ds_meta</span> <span class="params">(gpointer meta_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NvDsFrameMeta *params = (NvDsFrameMeta *) meta_data;</span><br><span class="line">    <span class="keyword">for</span> (guint i = <span class="number">0</span>; i &lt; params-&gt;num_rects; i++) &#123;</span><br><span class="line">        <span class="built_in">g_free</span> (params-&gt;obj_params[i].text_params.display_text);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">g_free</span> (params-&gt;obj_params);</span><br><span class="line">    <span class="built_in">g_free</span> (params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 添加一级检测的结果，如目标位置框信息。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">attach_metadata_full_frame</span> <span class="params">(GstDsExample * dsexample, GstBuffer * inbuf,</span></span></span><br><span class="line"><span class="params"><span class="function">    gdouble scale_ratio, DsExampleOutput * output, guint batch_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NvDsMeta *dsmeta;</span><br><span class="line">    NvDsFrameMeta *bbparams = (NvDsFrameMeta *) <span class="built_in">g_malloc0</span> (<span class="built_in"><span class="keyword">sizeof</span></span> (NvDsFrameMeta));</span><br><span class="line">    <span class="comment">// 根据检测到的目标数量申请对应的目标参数内存空间。</span></span><br><span class="line">    bbparams-&gt;obj_params =</span><br><span class="line">        (NvDsObjectParams *) <span class="built_in">g_malloc0</span> (<span class="built_in"><span class="keyword">sizeof</span></span> (NvDsObjectParams) *</span><br><span class="line">        output-&gt;numObjects);</span><br><span class="line">    <span class="built_in">GST_DEBUG_OBJECT</span> (dsexample, <span class="string">&quot;Attaching metadata %d\n&quot;</span>, output-&gt;numObjects);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 将NvDsFrameMeta以NvDsMeta的方式添加到buffer中。</span></span><br><span class="line">    dsmeta = <span class="built_in">gst_buffer_add_nvds_meta</span> (inbuf, bbparams, free_ds_meta);</span><br><span class="line">    <span class="comment">// 指定NvDsMeta的数据内容为NVDS_META_FRAME_INFO。</span></span><br><span class="line">    dsmeta-&gt;meta_type = NVDS_META_FRAME_INFO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 添加二级分类的结果。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">attach_metadata_object</span> <span class="params">(GstDsExample * dsexample, NvDsObjectParams * obj_param,</span></span></span><br><span class="line"><span class="params"><span class="function">    DsExampleOutput * output)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 用于向GStreamer注册插件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> gboolean</span></span><br><span class="line"><span class="function"><span class="title">dsexample_plugin_init</span> <span class="params">(GstPlugin * plugin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">GST_DEBUG_CATEGORY_INIT</span> (gst_dsexample_debug, <span class="string">&quot;dsexample&quot;</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;dsexample plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">gst_element_register</span> (plugin, <span class="string">&quot;dsexample&quot;</span>, GST_RANK_PRIMARY,</span><br><span class="line">        GST_TYPE_DSEXAMPLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">GST_PLUGIN_DEFINE</span> (GST_VERSION_MAJOR,</span><br><span class="line">    GST_VERSION_MINOR,</span><br><span class="line">    dsexample,</span><br><span class="line">    DESCRIPTION, dsexample_plugin_init, <span class="string">&quot;3.0&quot;</span>, LICENSE, BINARY_PACKAGE, URL)</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>&emsp;&emsp;这里仅作简单注释，为了减少篇幅也对源码进行了裁剪，详细源码参考官方。该文件可理解为插件的接口实现函数，可以对插件进行定制化开发，配置算法所需的参数文件、实现算法的初始化、配置插件属性、进行插件注册等工作。对于自定义算法的处理结果如何传递给下游插件，参考关于NvDsMeta的描述便可，NvDsMeta支持多种功能的数据格式。<br>&emsp;&emsp;这里插件的名字指定为dsexample，当然也可以根据自己的需求修改插件名字，官方有提供一些工具进行修改，我这里的话之间简单的将插件名字进行替换(对整个插件源代码进行替换)，也满足要求。<br>&emsp;&emsp;关于部署。插件编译成功部署的时候，仅需要把生成的.so文件放在/usr/lib/x86_64-linux-gnu/gstreamer-1.0/目录下。通过make install命令也可以实现同样的效果。<br>&emsp;&emsp;dsexample_lib相关文件为算法的具体实现文件，分为算法的初始化与算法的实现两部分，比较简单，本文不做过多阐述。  </p>
<h2 id="3-2-人体姿态估计算法插件"><a href="#3-2-人体姿态估计算法插件" class="headerlink" title="3.2 人体姿态估计算法插件"></a>3.2 人体姿态估计算法插件</h2><p>&emsp;&emsp;在实践过程中，以之前的人体姿态估计算法相关工作为切入点，完成了基于gst-dsexample的人体姿态估计算法插件开发。总体设计思想基于上文所述，配置了相关接口，将人体姿态估计算法嵌入插件中，实现功能。在后续考虑在git中上传源码，本文不做过多描述，仅贴出通过gst-inspect-1.0 dspose命令运行后的插件描述结果。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">Factory Details:</span><br><span class="line">Rank                     primary (256)</span><br><span class="line">Long-name                DsPose plugin</span><br><span class="line">Klass                    DsPose Plugin</span><br><span class="line">Description              Process a PoseEstimation algorithm on full frame</span><br><span class="line">Author                   xiaochengliu.prc@foxmail.com</span><br><span class="line"></span><br><span class="line">Plugin Details:</span><br><span class="line">Name                     nvdspose</span><br><span class="line">Description              pose plugin <span class="keyword">for</span> integration with DeepStream on DGPU</span><br><span class="line">Filename                 /usr/lib/x86_64-linux-gnu/gstreamer-1.0/libgstnvdspose.so</span><br><span class="line">Version                  3.0</span><br><span class="line">License                  Proprietary</span><br><span class="line">Source module            dspose</span><br><span class="line">Binary package           NVIDIA DeepStream 3rdparty IP integration pose plugin</span><br><span class="line">Origin URL               http://nvidia.com/</span><br><span class="line"></span><br><span class="line">GObject</span><br><span class="line">+----GInitiallyUnowned</span><br><span class="line">    +----GstObject</span><br><span class="line">            +----GstElement</span><br><span class="line">                +----GstBaseTransform</span><br><span class="line">                        +----GstDsPose</span><br><span class="line"></span><br><span class="line">Pad Templates:</span><br><span class="line">SRC template: <span class="string">&#x27;src&#x27;</span></span><br><span class="line">    Availability: Always</span><br><span class="line">    Capabilities:</span><br><span class="line">    video/x-raw(memory:NVMM)</span><br><span class="line">                format: &#123; NV12, RGBA &#125;</span><br><span class="line">                width: [ 1, 2147483647 ]</span><br><span class="line">                height: [ 1, 2147483647 ]</span><br><span class="line">            framerate: [ 0/1, 2147483647/1 ]</span><br><span class="line"></span><br><span class="line">SINK template: <span class="string">&#x27;sink&#x27;</span></span><br><span class="line">    Availability: Always</span><br><span class="line">    Capabilities:</span><br><span class="line">    video/x-raw(memory:NVMM)</span><br><span class="line">                format: &#123; NV12, RGBA &#125;</span><br><span class="line">                width: [ 1, 2147483647 ]</span><br><span class="line">                height: [ 1, 2147483647 ]</span><br><span class="line">            framerate: [ 0/1, 2147483647/1 ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Element Flags:</span><br><span class="line">no flags <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">Element Implementation:</span><br><span class="line">Has change_state() <span class="keyword">function</span>: gst_element_change_state_func</span><br><span class="line"></span><br><span class="line">Element has no clocking capabilities.</span><br><span class="line">Element has no URI handling capabilities.</span><br><span class="line"></span><br><span class="line">Pads:</span><br><span class="line">SINK: <span class="string">&#x27;sink&#x27;</span></span><br><span class="line">    Pad Template: <span class="string">&#x27;sink&#x27;</span></span><br><span class="line">SRC: <span class="string">&#x27;src&#x27;</span></span><br><span class="line">    Pad Template: <span class="string">&#x27;src&#x27;</span></span><br><span class="line"></span><br><span class="line">Element Properties:</span><br><span class="line">name                : The name of the object</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        String. Default: <span class="string">&quot;dspose0&quot;</span></span><br><span class="line">parent              : The parent of the object</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Object of <span class="built_in">type</span> <span class="string">&quot;GstObject&quot;</span></span><br><span class="line">qos                 : Handle Quality-of-Service events</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Boolean. Default: <span class="literal">false</span></span><br><span class="line">unique-id           : Unique ID <span class="keyword">for</span> the element. </span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Unsigned Integer. Range: 0 - 4294967295 Default: 15 </span><br><span class="line">processing-width    : Width of the input buffer to algorithm</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Integer. Range: 1 - 2147483647 Default: 1920 </span><br><span class="line">processing-height   : Height of the input buffer to algorithm</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Integer. Range: 1 - 2147483647 Default: 1080 </span><br><span class="line">full-frame          : Enable to process full frame</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Boolean. Default: <span class="literal">true</span></span><br><span class="line">gpu-id              : Set GPU Device ID</span><br><span class="line">                        flags: readable, writable, changeable only <span class="keyword">in</span> NULL or READY state</span><br><span class="line">                        Unsigned Integer. Range: 0 - 4294967295 Default: 0 </span><br><span class="line">model-file          : Set model file location</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        String. Default: null</span><br><span class="line">net-input-width     : Set Net input width</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Integer. Range: -1 - 2147483647 Default: -1 </span><br><span class="line">net-input-height    : Set Net input height</span><br><span class="line">                        flags: readable, writable</span><br><span class="line">                        Integer. Range: -1 - 2147483647 Default: 368 </span><br></pre></td></tr></table></figure></p>
<h2 id="3-3-全景拼接插件"><a href="#3-3-全景拼接插件" class="headerlink" title="3.3 全景拼接插件"></a>3.3 全景拼接插件</h2><p>&emsp;&emsp;暂无</p>
<h1 id="4-写在后面"><a href="#4-写在后面" class="headerlink" title="4. 写在后面"></a>4. 写在后面</h1><p>&emsp;&emsp;在接触DeepStream的过程中，会碰到莫名的一些坑，踏平这些坑花了不少时间。DeepStream个人感觉还是蛮好用的，不过好用在于能够快速部署和使用nvidia的一些技术，但是在实际项目使用过程中，由于DeepStream现在并没有开源，当中的插件功能可能并不能满足一些实际使用场景的需求，反而又需要自己去开发，那么可能最终演变成自己基于GStreamer编写基于NVIDIA生态的组件，相当于自己写一个DeepStream SDK。由于时间关系，没有办法仔细展开，待后续补充，虽然这个后续不知道要鸽到什么时候。<br>&emsp;&emsp;在一些单机的基于视频流的视频结构化分析应用场景中，DeepStream还是一个很好的框架的，可以快速完成原型部署，后面接kafka或者webrtc等就可以作为服务器往客户端传输结构化数据和视频图像啦。  </p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/05/ObjectTracking/" rel="next" title="目标跟踪KCF算法简介与优化">
                <i class="fa fa-chevron-left"></i> 目标跟踪KCF算法简介与优化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/OrangeAmoy" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%8A%80%E6%9C%AF%E7%AE%80%E4%BB%8B"><span class="nav-text">1. 技术简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B"><span class="nav-text">2. 安装教程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E4%BE%9D%E8%B5%96%E7%8E%AF%E5%A2%83"><span class="nav-text">2.1 依赖环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E7%A7%BB%E9%99%A4%E6%97%A7%E7%89%88%E6%9C%ACDeepStream-%E5%8F%AF%E9%80%89"><span class="nav-text">2.2 移除旧版本DeepStream(可选)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-text">2.3 安装步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85"><span class="nav-text">2.4 验证安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E5%8F%82%E8%80%83%E4%BE%8B%E5%AD%90"><span class="nav-text">3. 参考例子</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%85%B3%E4%BA%8Egst-dsexample"><span class="nav-text">3.1 关于gst-dsexample</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-gst-dsexample%E7%AE%80%E4%BB%8B"><span class="nav-text">3.1.1 gst-dsexample简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-gst-dsexample%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-text">3.1.2 gst-dsexample源码解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E4%BA%BA%E4%BD%93%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1%E7%AE%97%E6%B3%95%E6%8F%92%E4%BB%B6"><span class="nav-text">3.2 人体姿态估计算法插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%85%A8%E6%99%AF%E6%8B%BC%E6%8E%A5%E6%8F%92%E4%BB%B6"><span class="nav-text">3.3 全景拼接插件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%86%99%E5%9C%A8%E5%90%8E%E9%9D%A2"><span class="nav-text">4. 写在后面</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orange</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Hi9Me1ymYxpbQMv0ODXRUTw0-gzGzoHsz", "CMSESb0qQn5gGNtHhz8cWJT1");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  


  

  

</body>
</html>
